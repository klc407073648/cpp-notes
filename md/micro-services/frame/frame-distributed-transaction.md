# 分布式事务

> 本节主要介绍分布式事务的内容。

[[toc]]

# 目录

> - [为什么学](#why)
> - [学习哪些](#what)
> - [怎么学](#how)

# 事务的概念和目的

概念:

事务就是一组原子性的SQL查询，或者说是独立的工作单元。

事务的ACID概念：原子性(Atomicity),一致性(Consistency),隔离型(Isolation)以及持久性(Durability)。

![ACID原则](/_images/micro-services/frame/分布式事务/ACID原则.png)

目的：

最终目的是保障数据的可靠性，一致性。

# 分布式服务

**分布式服务案例:**

微服务下单业务，在下单时会调用订单服务，创建订单并写入数据库。然后订单服务调用账户服务和库存服务：

- 账户服务负责扣减用户余额
- 库存服务负责扣减商品库存

![分布式服务案例](/_images/micro-services/frame/分布式事务/分布式服务案例.png)

在分布式系统下，一个业务跨越多个服务或数据源，每个服务都是一个分支事务，要保证所有分支事务最终状态一致，这样的事务就是分布式事务。

![分布式服务案例问题](/_images/micro-services/frame/分布式事务/分布式服务案例问题.png)

# 分布式事务理论

## CAP定理

1998年，加州大学的计算机科学家 Eric Brewer 提出，分布式系统有三个指标：

- **Consistency（一致性）**
- **Availability（可用性）**
- **Partition tolerance （分区容错性）**

Eric Brewer 说，分布式系统无法同时满足这三个指标。这个结论就叫做 CAP 定理。

![CAP定理](/_images/micro-services/frame/分布式事务/CAP定理.png)

### CAP定理- Consistency

Consistency（一致性）：用户访问分布式系统中的任意节点，得到的数据必须一致。

![一致性](/_images/micro-services/frame/分布式事务/一致性.png)

### CAP定理- Availability

Availability （可用性）：用户访问集群中的任意健康节点，必须能得到响应，而不是超时或拒绝。

![可用性](/_images/micro-services/frame/分布式事务/可用性.png)

### CAP定理- Partition Tolerance

Partition（分区）：因为网络故障或其它原因导致分布式系统中的部分节点与其它节点失去连接，形成独立分区。

Tolerance（容错）：在集群出现分区时，整个系统也要持续对外提供服务。

![可用性](/_images/micro-services/frame/分布式事务/分区容错.png)

### 总结

简述CAP定理内容:
分布式系统节点通过网络连接，**一定会出现分区问题（P**）
当分区出现时，系统的一致性（C）和可用性（A）就无法同时满足。

## BASE定理

BASE理论是对CAP的一种解决思路，包含三个思想：

- **Basically Available （基本可用）**：分布式系统在出现故障时，允许损失部分可用性，即保证核心可用。
- **Soft State（软状态）**：在一定时间内，允许出现中间状态，比如临时的不一致状态。
- **Eventually Consistent（最终一致性）**：虽然无法保证强一致性，但是在软状态结束后，最终达到数据一致。


而分布式事务最大的问题是各个子事务的一致性问题，因此可以借鉴CAP定理和BASE理论：

- AP模式：各子事务分别执行和提交，允许出现结果不一致，然后采用弥补措施恢复数据即可，实现最终一致。
- CP模式：各个子事务执行后互相等待，同时提交，同时回滚，达成强一致。但事务等待过程中，处于弱可用状态。

### 分布式事务模型

解决分布式事务，各个子系统之间必须能感知到彼此的事务状态，才能保证状态一致，因此需要一个事务协调者来协调每一个事务的参与者（子系统事务）。
这里的子系统事务，称为分支事务；有关联的各个分支事务在一起称为全局事务。

![分布式事务模型](/_images/micro-services/frame/分布式事务/分布式事务模型.png)

### 总结

简述BASE理论三个思想：
- 基本可用
- 软状态
- 最终一致

解决分布式事务的思想和模型：

- 全局事务：整个分布式事务
- 分支事务：分布式事务中包含的每个子系统的事务
- 最终一致思想：各分支事务分别执行并提交，如果有不一致的情况，再想办法恢复数据
- 强一致思想：各分支事务执行完业务不要提交，等待彼此结果。而后统一提交或回滚
